# Designation Generator API (Backend)

This is the backend API for the Designation Generator application, built with NestJS, TypeORM, and PostgreSQL.

## Prerequisites

- Node.js (v18+ recommended)
- npm or yarn
- PostgreSQL server running
- Git

## Setup

1.  **Clone the repository (if applicable):**
    \`\`\`bash
    # git clone <repository-url>
    # cd designation-generator-backend
    \`\`\`

2.  **Install dependencies:**
    \`\`\`bash
    npm install
    # or
    # yarn install
    \`\`\`

3.  **Configure Environment Variables:**
    *   Copy the \`.env.example\` file to a new file named \`.env\`.
        \`\`\`bash
        cp .env.example .env
        \`\`\`
    *   Edit the \`.env\` file with your local configuration:
        *   \`PORT\`: Port for the backend server (default: 3000).
        *   \`DB_HOST\`, \`DB_PORT\`, \`DB_USERNAME\`, \`DB_PASSWORD\`, \`DB_DATABASE\`: PostgreSQL connection details.
        *   \`JWT_SECRET\`: A strong secret key for JWT token generation.
        *   \`JWT_EXPIRES_IN\`: Token expiration time (e.g., \`3600s\`, \`1d\`).
        *   \`BITRIX24_WEBHOOK_URL\`: Your Bitrix24 incoming webhook URL for task creation.
        *   \`BITRIX24_USER_FIELD_DESIGNATION_ID\`: The ID of the custom user field in Bitrix24 tasks where the product designation will be stored (e.g., \`UF_CRM_XXXXXX\`).

4.  **Database Setup:**
    *   Ensure your PostgreSQL server is running.
    *   Create the database specified in \`DB_DATABASE\` if it doesn't exist.

5.  **Run Database Migrations:**
    *   TypeORM migrations are used to manage the database schema.
    *   **Important:** Before running for the first time or after pulling changes with new entities, you might need to generate an initial migration if one doesn't exist or if entities have changed significantly since the last migration.
        \`\`\`bash
        # To generate a new migration (e.g., after adding/modifying entities)
        npm run migration:generate InitialSchema 
        # (replace InitialSchema with a descriptive name for your migration)
        \`\`\`
    *   To apply all pending migrations:
        \`\`\`bash
        npm run migration:run
        \`\`\`

## Running the Application

### Development Mode

\`\`\`bash
npm run start:dev
\`\`\`
This will start the NestJS application in watch mode, so it automatically rebuilds and restarts when you change source files. The API will typically be available at \`http://localhost:PORT\` (where \`PORT\` is from your \`.env\` file, e.g., 3000).

### Production Mode

\`\`\`bash
npm run build
npm run start:prod
\`\`\`
This first builds the application into the \`dist\` folder and then starts it from the compiled JavaScript files. For production, consider using a process manager like PM2.

## API Documentation (Swagger)

Once the application is running in development mode, API documentation (generated by Swagger/OpenAPI) is available at:
\`http://localhost:PORT/api/docs\` (e.g., \`http://localhost:3000/api/docs\`)

## Key Technologies

- **NestJS:** Progressive Node.js framework.
- **TypeORM:** ORM for TypeScript and JavaScript.
- **PostgreSQL:** Open source object-relational database.
- **JWT (JSON Web Tokens):** For stateless authentication.
- **class-validator & class-transformer:** For data validation and transformation.
- **Swagger (OpenAPI):** For API documentation.

## Project Structure Highlights

- \`src/\`: Main source code.
    - \`main.ts\`: Application entry point.
    - \`app.module.ts\`: Root module.
    - \`config/\`: Application configuration (\`.env\` loading, TypeORM setup).
    - \`auth/\`: Authentication (JWT, Passport strategies, guards).
    - \`users/\`: User entity and basic service.
    - \`products/\`: Product registration and management.
    - \`documents/\`: Document designation assignment.
    - \`custom-gost34-types/\`: Custom GOST 34 document types management.
    - \`integrations/\`: Bitrix24 integration logic.
    - \`migrations/\`: Database migration files.

## TypeORM CLI Commands

-   Generate a new migration: \`npm run migration:generate MyMigrationName\`
-   Run pending migrations: \`npm run migration:run\`
-   Revert the last migration: \`npm run migration:revert\`

Ensure \`src/config/typeorm-cli.config.ts\` is correctly configured for these commands.
